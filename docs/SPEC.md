# システム仕様書: QZSS災害用電源タップ

## 1. 概要
日常は時計やスマートタップとして機能し、災害時にはインターネット接続なしでQZSS L1S信号を受信して安全装置として働くフェーズフリーデバイス。

## 2. ハードウェア ピン配置

| コンポーネント | インターフェース | ピン / ポート | メモ |
|---|---|---|---|
| **QZ1** | USBシリアル | `/dev/ttyUSB0` | ボーレート 9600 (typ) |
| **MPU6050** | I2C | GPIO 2 (SDA), 3 (SCL) | アドレス `0x68` |
| **Relay 1** | GPIO | GPIO 4 | コンセント 1 制御 |
| **Relay 2** | GPIO | GPIO 17 | コンセント 2 制御 |
| **Relay 3** | GPIO | GPIO 27 | コンセント 3 制御 |
| **Relay 4** | GPIO | GPIO 22 | コンセント 4 制御 |
| **スピーカー** | PWM | GPIO 12 | アラーム出力 |
| **ボタン 1** | GPIO | GPIO 5 | リセット / 復旧 |
| **ボタン 2** | GPIO | GPIO 6 | モード切替 |
| **ボタン 3** | GPIO | GPIO 13 | （予備） |
| **ボタン 4** | GPIO | GPIO 19 | （予備） |
| **ボタン 5** | GPIO | GPIO 26 | テスト起動 |

## 3. ソフトウェア アーキテクチャ

### 3.1 ステートマシン
システムは中央のステートマシン（`src/core/state_machine.py`）によって管理されます:

- **BOOT (起動中)**: システムチェック。
- **NORMAL (正常)**: リレーON。時計表示。センサー監視中。
- **ALERT (緊急)**: リレーOFF。警報音。警告表示。
- **RECOVERY (復旧)**: ユーザー確認待ち。

### 3.2 アラート トリガー
- **QZSS**: 「J-ALERT」「緊急地震速報」「津波警報」の受信。
- **IMU**: 閾値（デフォルト 2.0G偏差）を超える加速度の検知。

### 3.3 フェーズフリー コンセプト
- **Phase 1 (日常時)**: 便利な道具（時計、充電ハブ）。
- **Phase 2 (非常時)**: 命と財産を守る道具（通電火災防止）。

### 3.4 Web連携
- **Webサーバー**: Node.js + Express (TypeScript) (Port 3000).
- **連携方式**: Pythonアプリ(TCP 65432)へコマンド送信.
- **機能**: ブラウザから個別のリレーをON/OFF操作可能（平常時のみ）.
    - API: `/api/relay` (POST `{relay: id, state: true/false}`).

## 4. GUI
- **ライブラリ**: DearPyGui.
- **解像度**: 800x480 等の小型スクリーンに最適化。
- **言語**: 日本語 (Noto Sans CJK)。
